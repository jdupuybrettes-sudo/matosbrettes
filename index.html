<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Scan Hilti → 9 chiffres</title>
  <style>
    :root{
      --bg:#0b0f17; --card:#111a2b; --line:#1c2333; --txt:#e9eef7;
      --muted:#9fb0c8; --btn:#2d6cdf; --btn2:#22304a; --ok:#7CFF9E; --warn:#ffd27c; --err:#ff7a7a;
    }
    body{ margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial; background:var(--bg); color:var(--txt); }
    header{ padding:14px 16px; border-bottom:1px solid var(--line); }
    h1{ margin:0; font-size:16px; opacity:.95; }
    main{ padding:16px; display:grid; gap:12px; max-width:720px; margin:0 auto; }
    .card{ background:var(--card); border:1px solid var(--line); border-radius:14px; padding:12px; }
    .hint{ color:var(--muted); font-size:13px; line-height:1.35; }
    .ok{ color:var(--ok); font-weight:800; }
    .warn{ color:var(--warn); font-weight:800; }
    .err{ color:var(--err); font-weight:800; white-space:pre-wrap; }
    video{
      width:100%;
      border-radius:12px;
      background:#000;
      aspect-ratio: 3/4;
      object-fit: cover;
    }
    .row{ display:flex; gap:10px; flex-wrap:wrap; margin-top:10px; }
    button, a.btn{
      appearance:none; border:0; border-radius:12px; padding:12px 14px;
      background:var(--btn); color:#fff; font-weight:900; text-decoration:none;
      display:inline-flex; align-items:center; gap:8px; cursor:pointer;
    }
    button.secondary, a.btn.secondary{ background:var(--btn2); color:var(--txt); }
    button:disabled{ opacity:.55; cursor:not-allowed; }
    .result{ font-size:28px; letter-spacing:1px; font-weight:900; margin-top:6px; }
    input{
      width:100%; padding:10px 12px; border-radius:10px;
      border:1px solid #2a3550; background:var(--bg); color:var(--txt);
      font-size:16px;
    }
    details{ margin-top:10px; }
    summary{ cursor:pointer; color:var(--muted); }
    pre{ background:#0a0d13; border:1px solid #1f2a40; padding:10px; border-radius:10px; overflow:auto; }
  </style>
</head>
<body>
  <header>
    <h1>Scanner Hilti → extrait uniquement les 9 chiffres</h1>
  </header>

  <main>
    <div class="card">
      <div class="hint">
        1) <b>Démarrer caméra</b> (obligatoire sur iPhone)<br/>
        2) Si flux OK mais pas de lecture, clique <b>Scanner</b><br/>
        3) On récupère le <span class="ok">premier bloc de 9 chiffres</span> puis <b>Copier</b><br/>
        <span class="warn">Astuce :</span> vise le code (DataMatrix) ou la ligne de chiffres.
      </div>
      <div id="error" class="err" style="margin-top:10px;"></div>
    </div>

    <div class="card">
      <video id="video" playsinline muted></video>

      <div class="row">
        <button id="btnCam">Démarrer caméra</button>
        <button id="btnSwitch" class="secondary" disabled>Basculer caméra</button>
        <button id="btnScan" class="secondary" disabled>Scanner</button>
        <button id="btnStop" class="secondary" disabled>Stop</button>
        <button id="btnCopy" class="secondary" disabled>Copier</button>
        <a id="back" class="btn secondary" href="#">Retour</a>
      </div>

      <details>
        <summary>Debug</summary>
        <pre id="dbg">—</pre>
        <pre id="raw">Texte brut : —</pre>
      </details>
    </div>

    <div class="card">
      <div class="hint">Résultat (9 chiffres) :</div>
      <div id="out" class="result">—</div>

      <div class="hint" style="margin-top:10px;">Ou colle/édite ici :</div>
      <input id="manual" placeholder="454844738" inputmode="numeric" autocomplete="off" />
    </div>
  </main>

  <script type="module">
    import { BrowserMultiFormatReader } from "https://cdn.jsdelivr.net/npm/@zxing/library@0.21.2/esm/index.min.js";

    const video   = document.getElementById("video");
    const out     = document.getElementById("out");
    const rawBox  = document.getElementById("raw");
    const dbgBox  = document.getElementById("dbg");
    const manual  = document.getElementById("manual");
    const errBox  = document.getElementById("error");

    const btnCam   = document.getElementById("btnCam");
    const btnScan  = document.getElementById("btnScan");
    const btnStop  = document.getElementById("btnStop");
    const btnCopy  = document.getElementById("btnCopy");
    const btnSwitch= document.getElementById("btnSwitch");
    const btnBack  = document.getElementById("back");

    const params = new URLSearchParams(location.search);
    const returnUrl = params.get("return") || "";
    btnBack.href = returnUrl || "javascript:history.back()";

    let stream = null;
    let devices = [];
    let currentDeviceIndex = -1;
    let scanning = false;

    const reader = new BrowserMultiFormatReader();

    function showError(e) {
      console.error(e);
      const name = e?.name || "Error";
      const msg  = e?.message || String(e);
      errBox.textContent = `${name}: ${msg}`;
    }
    function clearError(){ errBox.textContent = ""; }

    function extract9Digits(text) {
      if (!text) return "";

      // bloc exact de 9 chiffres
      const m1 = String(text).match(/\d{9}/);
      if (m1 && m1[0]) return m1[0];

      // groupements type 454 844 738 / 454-844-738
      const m2 = String(text).match(/\d[\d\s-]{7,}\d/g);
      if (m2 && m2.length) {
        for (const chunk of m2) {
          const digits = chunk.replace(/[^\d]/g, "");
          if (digits.length === 9) return digits;
          if (digits.length > 9) return digits.slice(0, 9);
        }
      }

      // fallback : tous chiffres, 9 premiers
      const all = String(text).replace(/\D/g, "");
      if (all.length === 9) return all;
      if (all.length > 9) return all.slice(0, 9);
      return "";
    }

    function updateDebug(extra="") {
      const s = stream?.getVideoTracks?.()?.[0]?.getSettings?.() || {};
      dbgBox.textContent =
        `video.readyState=${video.readyState}\n` +
        `videoWidth=${video.videoWidth} videoHeight=${video.videoHeight}\n` +
        `trackSettings=${JSON.stringify(s, null, 2)}\n` +
        (extra ? `\n${extra}` : "");
    }

    async function stopAll() {
      try { reader.reset(); } catch {}
      scanning = false;

      if (stream) {
        stream.getTracks().forEach(t => t.stop());
        stream = null;
      }
      video.srcObject = null;

      btnScan.disabled = true;
      btnStop.disabled = true;
      btnCopy.disabled = true;
      btnSwitch.disabled = true;

      updateDebug("stopped");
    }

    async function listDevices() {
      // Après permission, les labels deviennent dispos
      try {
        devices = await navigator.mediaDevices.enumerateDevices();
        devices = devices.filter(d => d.kind === "videoinput");
        // Choix caméra arrière : souvent label contient back/rear/environment
        const idxBack = devices.findIndex(d => /back|rear|environment/i.test(d.label));
        currentDeviceIndex = idxBack >= 0 ? idxBack : (devices.length ? devices.length - 1 : -1);

        btnSwitch.disabled = devices.length <= 1;
      } catch(e) {
        devices = [];
        currentDeviceIndex = -1;
      }
    }

    async function startCameraWithDevice(deviceId) {
      clearError();

      // Stop stream précédent
      if (stream) stream.getTracks().forEach(t => t.stop());

      // IMPORTANT iOS : playsinline + muted + play explicite
      video.setAttribute("playsinline", "true");
      video.muted = true;

      const baseConstraints = {
        audio: false,
        video: deviceId
          ? { deviceId: { exact: deviceId }, width: { ideal: 1280 }, height: { ideal: 720 } }
          : { facingMode: { ideal: "environment" }, width: { ideal: 1280 }, height: { ideal: 720 } }
      };

      try {
        stream = await navigator.mediaDevices.getUserMedia(baseConstraints);
      } catch(e) {
        // fallback sans contraintes (évite Overconstrained)
        try {
          stream = await navigator.mediaDevices.getUserMedia({ audio:false, video:true });
        } catch(e2) {
          showError(e2);
          throw e2;
        }
      }

      video.srcObject = stream;

      await new Promise(resolve => {
        video.onloadedmetadata = () => resolve();
      });

      await video.play();

      await listDevices();
      updateDebug("camera started");
      btnScan.disabled = false;
      btnStop.disabled = false;
    }

    async function startCamera() {
      try {
        if (!navigator.mediaDevices?.getUserMedia) {
          throw new Error("getUserMedia non disponible.");
        }
        await startCameraWithDevice(null);
      } catch(e) {
        showError(e);
      }
    }

    async function switchCamera() {
      if (!devices.length) return;
      currentDeviceIndex = (currentDeviceIndex + 1) % devices.length;
      const deviceId = devices[currentDeviceIndex]?.deviceId;
      if (!deviceId) return;
      try {
        await startCameraWithDevice(deviceId);
      } catch(e) {
        showError(e);
      }
    }

    function setResult(rawText) {
      rawBox.textContent = "Texte brut : " + (rawText || "—");
      const code = extract9Digits(rawText) || extract9Digits(manual.value) || "";
      if (!code) return;

      out.textContent = code;
      manual.value = code;
      btnCopy.disabled = false;

      if (navigator.vibrate) navigator.vibrate(80);
    }

    async function startScan() {
      if (scanning) return;
      if (!video.srcObject) {
        showError(new Error("Démarre la caméra d’abord."));
        return;
      }

      scanning = true;
      clearError();
      updateDebug("scanning…");

      // lecture continue sur le flux vidéo déjà affiché
      reader.decodeFromVideoElementContinuously(video, (result, err) => {
        if (result?.getText) {
          const txt = result.getText();
          setResult(txt);

          // Stop dès qu'on a un code 9 chiffres
          if (extract9Digits(txt)) {
            try { reader.reset(); } catch {}
            scanning = false;
            updateDebug("scan ok (stopped)");
          }
        }
        // NotFoundException = normal (pas de code dans l'image)
      });
    }

    async function copy() {
      const code = (manual.value || "").trim();
      if (!code) return;

      try {
        await navigator.clipboard.writeText(code);
        out.textContent = code + " ✅";
      } catch {
        manual.focus();
        manual.select();
        out.textContent = code + " (sélectionné)";
      }

      if (returnUrl) setTimeout(() => location.href = returnUrl, 250);
    }

    btnCam.addEventListener("click", startCamera);
    btnSwitch.addEventListener("click", switchCamera);
    btnScan.addEventListener("click", startScan);
    btnStop.addEventListener("click", stopAll);
    btnCopy.addEventListener("click", copy);

    manual.addEventListener("input", () => {
      const c = extract9Digits(manual.value);
      btnCopy.disabled = !c;
      if (c) out.textContent = c;
    });

    // petit refresh debug
    setInterval(() => updateDebug(), 1200);
  </script>
</body>
</html>
