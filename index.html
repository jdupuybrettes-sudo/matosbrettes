<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Scan Hilti → 9 chiffres</title>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial; margin: 16px; }
    video { width: 100%; max-width: 520px; border-radius: 12px; background:#000; }
    .row { display:flex; gap:10px; flex-wrap:wrap; margin-top:12px; }
    button { padding:12px 14px; border:0; border-radius:10px; cursor:pointer; }
    button.primary { background:#0b5; color:white; }
    button.gray { background:#eee; }
    .box { padding:12px; border:1px solid #ddd; border-radius:12px; margin-top:12px; max-width:520px; }
    input { width:100%; padding:12px; font-size:18px; border:1px solid #ddd; border-radius:10px; }
    .small { color:#666; font-size:13px; }
    .code { font-size:26px; letter-spacing:1px; font-weight:700; }
  </style>
</head>
<body>
  <h2>Scanner Hilti → code 9 chiffres</h2>
  <p class="small">Astuce : vise bien le code (DataMatrix). Le résultat copié = <b>9 chiffres</b> uniquement.</p>

  <video id="video" playsinline></video>

  <div class="box">
    <div class="small">Code détecté :</div>
    <div id="out" class="code">—</div>
    <div class="row">
      <button class="primary" id="btnCopy" disabled>Copier</button>
      <button class="gray" id="btnRestart">Relancer</button>
      <button class="gray" id="btnStop">Stop</button>
    </div>
    <p class="small">Si besoin, tu peux coller manuellement dans Glide ensuite.</p>
  </div>

  <div class="box">
    <div class="small">Test manuel (facultatif) :</div>
    <input id="manual" placeholder="Colle ici un texte/scan, je sors les 9 chiffres" />
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@zxing/library@0.20.0"></script>
  <script>
    const video = document.getElementById("video");
    const out = document.getElementById("out");
    const btnCopy = document.getElementById("btnCopy");
    const btnRestart = document.getElementById("btnRestart");
    const btnStop = document.getElementById("btnStop");
    const manual = document.getElementById("manual");

    let codeReader;
    let lastCode = "";

    function extract9(raw) {
      if (!raw) return "";
      // 1) cherche un bloc de 9 chiffres dans le texte brut
      const m = String(raw).match(/\d{9}/);
      if (m && m[0]) return m[0];

      // 2) sinon: garde uniquement les chiffres, puis tente de trouver 9 chiffres
      const digits = String(raw).replace(/\D/g, "");
      if (digits.length === 9) return digits;
      if (digits.length > 9) {
        // prend le PREMIER groupe de 9 (le plus fréquent sur Hilti)
        return digits.slice(0, 9);
      }
      return "";
    }

    function setCode(code) {
      lastCode = code || "";
      out.textContent = lastCode || "—";
      btnCopy.disabled = !lastCode;

      if (lastCode) {
        // petit feedback
        if (navigator.vibrate) navigator.vibrate(80);
      }
    }

    async function startScan() {
      setCode("");
      codeReader = new ZXing.BrowserMultiFormatReader();

      try {
        const devices = await ZXing.BrowserCodeReader.listVideoInputDevices();
        const deviceId = devices?.[0]?.deviceId;

        await codeReader.decodeFromVideoDevice(deviceId, video, (result, err) => {
          if (result) {
            const raw = result.getText();
            const code9 = extract9(raw);
            if (code9) {
              setCode(code9);
              // stop dès qu'on a un vrai code 9 chiffres
              try { codeReader.reset(); } catch(e) {}
            }
          }
        });
      } catch (e) {
        alert("Caméra indisponible. Vérifie Safari + HTTPS + autorisation caméra.\n\n" + e);
      }
    }

    btnCopy.addEventListener("click", async () => {
      if (!lastCode) return;
      try {
        await navigator.clipboard.writeText(lastCode);
        btnCopy.textContent = "Copié ✔";
        setTimeout(() => btnCopy.textContent = "Copier", 900);
      } catch (e) {
        alert("Impossible de copier automatiquement. Copie manuelle: " + lastCode);
      }
    });

    btnRestart.addEventListener("click", () => startScan());
    btnStop.addEventListener("click", () => { try { codeReader.reset(); } catch(e) {} });

    manual.addEventListener("input", () => {
      const c = extract9(manual.value);
      setCode(c);
    });

    startScan();
  </script>
</body>
</html>
