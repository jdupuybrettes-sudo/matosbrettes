<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Scan Hilti → 9 chiffres</title>
  <style>
    :root{
      --bg:#0b0f17; --card:#111a2b; --line:#1c2333; --txt:#e9eef7;
      --muted:#9fb0c8; --btn:#2d6cdf; --btn2:#22304a; --ok:#7CFF9E; --warn:#ffd27c; --err:#ff7a7a;
    }
    body{ margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial; background:var(--bg); color:var(--txt); }
    header{ padding:14px 16px; border-bottom:1px solid var(--line); }
    h1{ margin:0; font-size:16px; opacity:.95; }
    main{ padding:16px; display:grid; gap:12px; max-width:620px; margin:0 auto; }
    .card{ background:var(--card); border:1px solid var(--line); border-radius:14px; padding:12px; }
    .hint{ color:var(--muted); font-size:13px; line-height:1.35; }
    .ok{ color:var(--ok); font-weight:700; }
    .warn{ color:var(--warn); font-weight:700; }
    .err{ color:var(--err); font-weight:700; white-space:pre-wrap; }
    video{
      width:100%;
      border-radius:12px;
      background:#000;
      aspect-ratio: 3/4;
      object-fit: cover;
    }
    .row{ display:flex; gap:10px; flex-wrap:wrap; margin-top:10px; }
    button, a.btn{
      appearance:none; border:0; border-radius:12px; padding:12px 14px;
      background:var(--btn); color:#fff; font-weight:800; text-decoration:none;
      display:inline-flex; align-items:center; gap:8px; cursor:pointer;
    }
    button.secondary, a.btn.secondary{ background:var(--btn2); color:var(--txt); }
    button:disabled{ opacity:.55; cursor:not-allowed; }
    .result{ font-size:28px; letter-spacing:1px; font-weight:900; margin-top:6px; }
    input{
      width:100%; padding:10px 12px; border-radius:10px;
      border:1px solid #2a3550; background:var(--bg); color:var(--txt);
      font-size:16px;
    }
    details{ margin-top:8px; }
    summary{ cursor:pointer; color:var(--muted); }
    pre{ background:#0a0d13; border:1px solid #1f2a40; padding:10px; border-radius:10px; overflow:auto; }
  </style>
</head>
<body>
  <header>
    <h1>Scanner Hilti → extrait uniquement les 9 chiffres</h1>
  </header>

  <main>
    <div class="card">
      <div class="hint">
        1) Clique <b>Démarrer</b> → autorise la caméra<br/>
        2) Vise le <b>DataMatrix/QR</b> ou la ligne de chiffres<br/>
        3) On récupère le <span class="ok">premier bloc de 9 chiffres</span> puis <b>Copier</b><br/>
        <span class="warn">Astuce iPhone :</span> ça marche dans Safari (pas dans un navigateur intégré).
      </div>
      <div id="error" class="err" style="margin-top:10px;"></div>
    </div>

    <div class="card">
      <video id="video" autoplay playsinline muted></video>

      <div class="row">
        <button id="start">Démarrer</button>
        <button id="stop" class="secondary" disabled>Stop</button>
        <button id="copy" class="secondary" disabled>Copier</button>
        <a id="back" class="btn secondary" href="#">Retour</a>
      </div>

      <details>
        <summary>Debug (texte brut lu)</summary>
        <pre id="raw">—</pre>
      </details>
    </div>

    <div class="card">
      <div class="hint">Résultat (9 chiffres) :</div>
      <div id="out" class="result">—</div>

      <div class="hint" style="margin-top:10px;">Ou colle/édite ici (si besoin) :</div>
      <input id="manual" placeholder="454844738" inputmode="numeric" autocomplete="off" />

      <div class="hint" style="margin-top:10px;">
        Si le code lu contient d’autres infos, on garde automatiquement le <span class="ok">premier groupe de 9 chiffres</span>.
      </div>
    </div>
  </main>

  <script type="module">
    import { BrowserMultiFormatReader } from "https://cdn.jsdelivr.net/npm/@zxing/library@0.21.2/esm/index.min.js";

    const video   = document.getElementById("video");
    const out     = document.getElementById("out");
    const rawBox  = document.getElementById("raw");
    const manual  = document.getElementById("manual");
    const errBox  = document.getElementById("error");

    const btnStart = document.getElementById("start");
    const btnStop  = document.getElementById("stop");
    const btnCopy  = document.getElementById("copy");
    const btnBack  = document.getElementById("back");

    const params = new URLSearchParams(location.search);
    const returnUrl = params.get("return") || "";
    btnBack.href = returnUrl || "javascript:history.back()";

    const reader = new BrowserMultiFormatReader();
    let active = false;
    let lastCode = "";

    function showError(e) {
      console.error(e);
      const name = e?.name || "Error";
      const msg  = e?.message || String(e);
      errBox.textContent = `${name}: ${msg}`;
    }

    function clearError() {
      errBox.textContent = "";
    }

    // Extrait le 1er code de 9 chiffres trouvé.
    function extract9Digits(text) {
      if (!text) return "";

      // 1) direct : un bloc exact de 9 chiffres
      const m1 = String(text).match(/\d{9}/);
      if (m1 && m1[0]) return m1[0];

      // 2) groupements possibles : "454 844 738" ou "454-844-738"
      const m2 = String(text).match(/\d[\d\s-]{7,}\d/g);
      if (m2 && m2.length) {
        for (const chunk of m2) {
          const digits = chunk.replace(/[^\d]/g, "");
          if (digits.length === 9) return digits;
          if (digits.length > 9) return digits.slice(0, 9);
        }
      }

      // 3) fallback : garde tous les chiffres, prends les 9 premiers si possible
      const digitsAll = String(text).replace(/\D/g, "");
      if (digitsAll.length === 9) return digitsAll;
      if (digitsAll.length > 9) return digitsAll.slice(0, 9);

      return "";
    }

    function setResult(rawText) {
      rawBox.textContent = rawText || "—";
      const code = extract9Digits(rawText) || extract9Digits(manual.value) || "";

      if (!code) return;

      lastCode = code;
      out.textContent = code;
      manual.value = code;
      btnCopy.disabled = false;

      if (navigator.vibrate) navigator.vibrate(80);

      // Stop auto pour éviter double lecture
      stop();
    }

    async function start() {
      if (active) return;
      clearError();

      // IMPORTANT iOS : doit être appelé suite à un clic
      active = true;
      btnStart.disabled = true;
      btnStop.disabled = false;
      btnCopy.disabled = true;
      out.textContent = "…";
      rawBox.textContent = "—";

      try {
        // Utilise decodeFromConstraints pour éviter facingMode "exact" (source de bugs)
        const constraints = {
          audio: false,
          video: {
            facingMode: { ideal: "environment" },
            width:  { ideal: 1280 },
            height: { ideal: 720 }
          }
        };

        await reader.decodeFromConstraints(constraints, video, (result, err) => {
          if (result) {
            const txt = result.getText?.() ?? "";
            setResult(txt);
          }
          // On ignore les erreurs "NotFoundException" (pas de code dans l'image) : normal
        });

        // Forcer play (iOS)
        await video.play();
      } catch (e) {
        showError(e);

        // Fallback sans contrainte environment
        try {
          const fallback = { audio: false, video: true };
          await reader.decodeFromConstraints(fallback, video, (result, err) => {
            if (result) setResult(result.getText?.() ?? "");
          });
          await video.play();
        } catch (e2) {
          showError(e2);
          stop();
        }
      }
    }

    function stop() {
      if (!active) return;
      active = false;

      try { reader.reset(); } catch {}
      btnStart.disabled = false;
      btnStop.disabled = true;
    }

    async function copy() {
      const code = (manual.value || "").trim();
      if (!code) return;

      try {
        await navigator.clipboard.writeText(code);
        out.textContent = code + " ✅";
      } catch (e) {
        // Fallback : sélection
        manual.focus();
        manual.select();
        out.textContent = code + " (sélectionné)";
      }

      // Retour auto si return= fourni
      if (returnUrl) setTimeout(() => location.href = returnUrl, 250);
    }

    btnStart.addEventListener("click", start);
    btnStop.addEventListener("click", stop);
    btnCopy.addEventListener("click", copy);

    manual.addEventListener("input", () => {
      const c = extract9Digits(manual.value);
      if (c) {
        lastCode = c;
        out.textContent = c;
        btnCopy.disabled = false;
      } else {
        btnCopy.disabled = true;
      }
    });
  </script>
</body>
</html>
