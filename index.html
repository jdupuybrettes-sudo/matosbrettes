<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Scanner Matos BRETTES</title>
  <style>
    :root { --bg:#0b1220; --card:#0f172a; --text:#e5e7eb; --muted:#94a3b8; --accent:#60a5fa; }
    *{box-sizing:border-box;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;}
    body{margin:0;background:linear-gradient(180deg,#050814,#0b1220);color:var(--text);min-height:100vh;display:flex;align-items:center;justify-content:center;padding:16px;}
    .wrap{width:min(520px,100%);display:flex;flex-direction:column;gap:12px;}
    .card{background:rgba(15,23,42,.85);border:1px solid rgba(148,163,184,.15);border-radius:22px;overflow:hidden;box-shadow:0 20px 60px rgba(0,0,0,.35);}
    .top{padding:14px 16px;border-bottom:1px solid rgba(148,163,184,.12);display:flex;gap:10px;align-items:center;justify-content:space-between;}
    .title{font-weight:800;letter-spacing:.04em;text-transform:uppercase;font-size:12px;color:var(--muted)}
    .status{font-size:12px;color:var(--muted)}
    .videoBox{position:relative;aspect-ratio:1/1;background:#000;}
    video{width:100%;height:100%;object-fit:cover;display:block;}
    .reticle{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;pointer-events:none;}
    .frame{width:68%;height:42%;border:2px solid rgba(255,255,255,.18);border-radius:18px;background:rgba(0,0,0,.05);position:relative}
    .c{position:absolute;width:18px;height:18px;border:4px solid var(--accent);}
    .tl{top:-2px;left:-2px;border-right:none;border-bottom:none;border-top-left-radius:14px;}
    .tr{top:-2px;right:-2px;border-left:none;border-bottom:none;border-top-right-radius:14px;}
    .bl{bottom:-2px;left:-2px;border-right:none;border-top:none;border-bottom-left-radius:14px;}
    .br{bottom:-2px;right:-2px;border-left:none;border-top:none;border-bottom-right-radius:14px;}
    .overlay{position:absolute;inset:0;display:none;align-items:center;justify-content:center;flex-direction:column;gap:12px;background:rgba(2,6,23,.78);backdrop-filter:blur(6px);padding:18px;text-align:center;}
    .overlay.show{display:flex;}
    button{border:0;border-radius:16px;padding:14px 14px;font-weight:800;letter-spacing:.08em;text-transform:uppercase;font-size:11px;cursor:pointer;}
    .btn{background:#fff;color:#0b1220;}
    .btn2{background:rgba(255,255,255,.10);color:#fff;border:1px solid rgba(255,255,255,.15);}
    .row{display:flex;gap:10px;flex-wrap:wrap;padding:12px;}
    .row button{flex:1 1 140px;}
    .small{font-size:12px;color:var(--muted);line-height:1.35;}
    .manual{padding:12px;border-top:1px solid rgba(148,163,184,.12);display:flex;gap:10px;align-items:center;}
    input{flex:1;border-radius:14px;border:1px solid rgba(148,163,184,.18);background:rgba(2,6,23,.35);color:#fff;padding:12px 12px;font-size:14px;outline:none;}
    input:focus{border-color:rgba(96,165,250,.6)}
    .pill{padding:10px 12px;border-radius:999px;background:rgba(96,165,250,.12);border:1px solid rgba(96,165,250,.25);color:#bfdbfe;font-size:12px;}
    .hint{padding:12px 14px}
    a{color:#bfdbfe}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <div class="top">
        <div class="title">Scanner Matos BRETTES</div>
        <div class="status" id="status">Initialisation…</div>
      </div>

      <div class="videoBox">
        <video id="video" playsinline muted></video>

        <div class="reticle">
          <div class="frame">
            <div class="c tl"></div><div class="c tr"></div><div class="c bl"></div><div class="c br"></div>
          </div>
        </div>

        <div class="overlay" id="overlay">
          <div class="pill">Autorisation caméra requise</div>
          <div class="small">
            Si l’autodémarrage est bloqué (souvent iPhone), appuie sur <b>Démarrer</b>.
            <br/>Astuce reflets : mets l’étiquette à l’ombre + incline le téléphone 5–15°.
          </div>
          <button class="btn" id="btnStart">Démarrer</button>
        </div>
      </div>

      <div class="row">
        <button class="btn2" id="btnTorch" disabled>Lampe</button>
        <button class="btn2" id="btnZoomOut" disabled>Zoom -</button>
        <button class="btn2" id="btnZoomIn" disabled>Zoom +</button>
      </div>

      <div class="manual">
        <input id="manual" inputmode="numeric" placeholder="Saisie manuelle (9 chiffres)" />
        <button class="btn" id="btnGo">OK</button>
      </div>

      <div class="hint small">
        <b>But :</b> lire un code (QR / DataMatrix / Code128…) puis renvoyer vers Glide :
        <span id="returnInfo"></span>
      </div>
    </div>
  </div>

  <script type="module">
    import { BrowserMultiFormatReader } from "https://esm.run/@zxing/browser";
    import { DecodeHintType, BarcodeFormat } from "https://esm.run/@zxing/library";

    const video = document.getElementById("video");
    const statusEl = document.getElementById("status");
    const overlay = document.getElementById("overlay");
    const btnStart = document.getElementById("btnStart");

    const btnTorch = document.getElementById("btnTorch");
    const btnZoomIn = document.getElementById("btnZoomIn");
    const btnZoomOut = document.getElementById("btnZoomOut");

    const manual = document.getElementById("manual");
    const btnGo = document.getElementById("btnGo");
    const returnInfo = document.getElementById("returnInfo");

    // --- Helpers URL
    const qs = new URLSearchParams(window.location.search);
    const returnUrl = qs.get("return") ? decodeURIComponent(qs.get("return")) : null;

    returnInfo.textContent = returnUrl ? returnUrl : "(aucun return — mode test)";

    function normalizeCode(raw) {
      const s = (raw || "").trim();
      // extrait 9 chiffres si présents (cas étiquette / texte)
      const m = s.match(/\d{9}/);
      if (m) return m[0];
      // sinon on garde brut (QR/DM)
      return s;
    }

    function redirectToGlide(code) {
      const finalCode = normalizeCode(code);
      if (!finalCode) return;

      stopAll();

      if (returnUrl) {
        const sep = returnUrl.includes("?") ? "&" : "?";
        window.location.assign(`${returnUrl}${sep}code=${encodeURIComponent(finalCode)}`);
      } else {
        // fallback test : affiche + copie
        statusEl.textContent = `Lu: ${finalCode}`;
        navigator.clipboard?.writeText(finalCode).catch(()=>{});
        alert("Lu : " + finalCode);
      }
    }

    // --- Camera / Track controls
    let stream = null;
    let track = null;
    let reader = null;
    let scanning = false;
    let torchOn = false;

    let zoomMin = 1;
    let zoomMax = 1;
    let zoom = 1;

    function setStatus(t) { statusEl.textContent = t; }

    function getCaps() {
      if (!track || !track.getCapabilities) return {};
      return track.getCapabilities();
    }

    async function applyTorch(on) {
      if (!track) return;
      try {
        await track.applyConstraints({ advanced: [{ torch: !!on }] });
        torchOn = !!on;
        btnTorch.textContent = torchOn ? "Lampe ON" : "Lampe";
      } catch {}
    }

    async function applyZoom(z) {
      if (!track) return;
      const clamped = Math.max(zoomMin, Math.min(zoomMax, z));
      try {
        await track.applyConstraints({ advanced: [{ zoom: clamped }] });
        zoom = clamped;
      } catch {}
    }

    // --- ZXing setup (TRY_HARDER + ALSO_INVERTED)
    function buildHints() {
      const hints = new Map();
      hints.set(DecodeHintType.TRY_HARDER, true);
      hints.set(DecodeHintType.ALSO_INVERTED, true);
      hints.set(DecodeHintType.POSSIBLE_FORMATS, [
        BarcodeFormat.DATA_MATRIX,
        BarcodeFormat.QR_CODE,
        BarcodeFormat.CODE_128,
        BarcodeFormat.CODE_39,
        BarcodeFormat.EAN_13,
        BarcodeFormat.EAN_8,
      ]);
      return hints;
    }

    async function startCameraAndScan() {
      if (scanning) return;
      scanning = true;

      overlay.classList.remove("show");
      setStatus("Demande caméra…");

      try {
        stream = await navigator.mediaDevices.getUserMedia({
          video: {
            facingMode: { ideal: "environment" },
            width: { ideal: 1920 },
            height: { ideal: 1080 },
            frameRate: { ideal: 30, max: 60 }
          },
          audio: false
        });

        video.srcObject = stream;
        await video.play();

        track = stream.getVideoTracks()[0];

        // Capacités torch/zoom
        const caps = getCaps();

        // Torch
        btnTorch.disabled = !caps.torch;
        btnTorch.textContent = "Lampe";
        torchOn = false;

        // Zoom
        const zc = caps.zoom;
        if (zc && typeof zc.min === "number" && typeof zc.max === "number") {
          zoomMin = zc.min;
          zoomMax = zc.max;
          zoom = zoomMin;
          btnZoomIn.disabled = false;
          btnZoomOut.disabled = false;
          // léger zoom par défaut si dispo (souvent mieux pour étiquettes)
          await applyZoom(Math.min(zoomMin + 0.8, zoomMax));
        } else {
          btnZoomIn.disabled = true;
          btnZoomOut.disabled = true;
        }

        // ZXing continuous scan
        setStatus("Scan en cours…");

        reader = new BrowserMultiFormatReader(buildHints(), 300);
        // decodeFromVideoDevice(null, videoElement, callback)
        await reader.decodeFromVideoDevice(null, video, (result, err) => {
          if (result) {
            redirectToGlide(result.getText());
          }
        });

      } catch (e) {
        scanning = false;
        setStatus("Caméra bloquée (permission/HTTPS).");
        overlay.classList.add("show");
      }
    }

    function stopAll() {
      scanning = false;

      try { reader?.reset(); } catch {}
      reader = null;

      if (track) { try { track.stop(); } catch {} }
      track = null;

      if (stream) { try { stream.getTracks().forEach(t => t.stop()); } catch {} }
      stream = null;

      if (video) video.srcObject = null;
    }

    // --- UI events
    btnStart.addEventListener("click", startCameraAndScan);

    btnTorch.addEventListener("click", async () => {
      if (btnTorch.disabled) return;
      await applyTorch(!torchOn);
    });

    btnZoomIn.addEventListener("click", async () => {
      if (btnZoomIn.disabled) return;
      await applyZoom(zoom + 0.6);
    });

    btnZoomOut.addEventListener("click", async () => {
      if (btnZoomOut.disabled) return;
      await applyZoom(zoom - 0.6);
    });

    btnGo.addEventListener("click", () => {
      const v = manual.value || "";
      if (!v.trim()) return;
      redirectToGlide(v);
    });

    manual.addEventListener("keydown", (e) => {
      if (e.key === "Enter") btnGo.click();
    });

    // --- Auto start (si possible)
    // 1) tente l'autostart
    // 2) si iOS bloque -> overlay + bouton Démarrer
    startCameraAndScan();
  </script>
</body>
</html>
